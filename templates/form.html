<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Request Form</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/form.css') }}">
    <style>
        body, html {
            background-image: url('{{ url_for('static', filename='assets/bg-img.png') }}');
        }
    </style>
    <script>
        async function fetchManagersAndGates() {
            try {
                const response = await fetch('/api/managers_and_gates');
                const data = await response.json();
                populateForm(data);
            } catch (error) {
                console.error('Error fetching managers and gates:', error);
            }
        }

        function populateForm(data) {
            const managerSelect = document.getElementById('manager');
            const gateSelect = document.getElementById('gateNumber');

            data.managers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager.id;
                option.textContent = manager.name + " (" + manager.department + ")";
                managerSelect.appendChild(option);
            });

            data.gates.forEach(gate => {
                const option = document.createElement('option');
                option.value = gate.id;
                option.textContent = gate.gate_number;
                gateSelect.appendChild(option);
            });
        }

        document.addEventListener('DOMContentLoaded', fetchManagersAndGates);

        function addVisitorField() {
            const visitorsContainer = document.getElementById('VisitorsContainer');
            const visitorIndex = visitorsContainer.childElementCount / 7; // Adjusted to 7 fields per visitor
            const visitorDiv = document.createElement('div');
            visitorDiv.innerHTML = `
                <div>
                    <label for="firstName[${visitorIndex}]">First Name:</label>
                    <input type="text" name="firstName[${visitorIndex}]" required>
                    <label for="lastName[${visitorIndex}]">Last Name:</label>
                    <input type="text" name="lastName[${visitorIndex}]" required>
                    <label for="phoneNumber[${visitorIndex}]">Phone Number:</label>
                    <input type="text" name="phoneNumber[${visitorIndex}]" required>
                    <label for="idNumber[${visitorIndex}]">ID/Iqama Number:</label>
                    <input type="text" name="idNumber[${visitorIndex}]" required>
                    <label for="email[${visitorIndex}]">Email:</label>
                    <input type="email" name="email[${visitorIndex}]" required>
                    <label for="idAttachment[${visitorIndex}]">ID Attachment:</label>
                    <input type="file" name="idAttachment[${visitorIndex}]" required>
                    <button type="button" onclick="removeVisitorField(this)">Remove</button>
                </div>
            `;
            visitorsContainer.appendChild(visitorDiv);
        }

        function removeVisitorField(button) {
            const visitorsContainer = document.getElementById('VisitorsContainer');
            visitorsContainer.removeChild(button.parentElement);
        }

        function addTimeSlot() {
            const timeSlotContainer = document.getElementById('timeSlotsContainer');
            const timeSlotDiv = document.createElement('div');
            timeSlotDiv.style.display = 'flex';
            timeSlotDiv.style.alignItems = 'center';
            timeSlotDiv.style.marginBottom = '10px';
            timeSlotDiv.innerHTML = `
                <label for="visitDate" style="margin-right: 5px;">Visit Date:</label>
                <input type="date" name="visitDate[]" required style="margin-right: 10px;">
                <label for="startTime" style="margin-right: 5px;">From:</label>
                <input type="time" name="startTime[]" required style="margin-right: 10px;">
                <label for="endTime" style="margin-right: 5px;">To:</label>
                <input type="time" name="endTime[]" required style="margin-right: 10px;">
                <button type="button" onclick="removeTimeSlot(this)" style="margin-left: 10px;">Remove</button>
            `;
            timeSlotContainer.appendChild(timeSlotDiv);
        }

        function removeTimeSlot(button) {
            const timeSlotContainer = document.getElementById('timeSlotsContainer');
            timeSlotContainer.removeChild(button.parentElement);
        }

        document.addEventListener('DOMContentLoaded', () => {
            addVisitorField();
            addTimeSlot();
        });
    </script>
</head>
<body>
    <div class="navbar">
        <div class="logo">
            <img src="{{ url_for('static', filename='assets/Camreon-icon.jpeg') }}" alt="Logo">
        </div>
        <div class="nav-options">
            <a href="{{ url_for('index') }}">Home</a>
            <a href="#">Link</a>
            <a href="#">Dropdown</a>
            <a href="#" class="disabled">Disabled</a>
        </div>
    </div>

    <div class="container">
        <div class="left">
            <h1>Visitor Request Form</h1>
            <p>This Form will help the company to manage the system better</p>
            <p>Schedule an appointment to visit the company by filling the fields and choosing a manager</p>
        </div>
        <div class="right">
            <form id="visitForm" action="/submit" method="POST" enctype="multipart/form-data">
                <label for="numVisitors">Choose the number of Visitors:</label><br>
                <input type="number" id="numVisitors" name="numVisitors" min="1" max="15" value="1" class="contact-inputs" onchange="addVisitorField()"><br><br>

                <div id="VisitorsContainer"></div>

                <div id="timeSlotsContainer">
                    <label>Visit Time Slots:</label>
                    <button type="button" onclick="addTimeSlot()">Add Time Slot</button>
                </div>

                <label for="manager">CHOOSE A MANAGER*</label><br>
                <select id="manager" name="manager" required></select><br><br>
                <label for="gateNumber">Gate Number:</label>
                <select id="gateNumber" name="gateNumber" required></select><br><br>

                <input type="hidden" name="status" value="Pending">

                <button type="submit">Submit</button>
            </form>
        </div>
    </div>
</body>
</html>
